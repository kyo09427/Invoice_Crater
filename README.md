# Invoice Creator (精算書作成アプリ)

[![Flutter](https://img.shields.io/badge/Flutter-3.10+-02569B?logo=flutter)](https://flutter.dev)
[![Dart](https://img.shields.io/badge/Dart-3.10+-0175C2?logo=dart)](https://dart.dev)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

Flutterで作成された精算書作成・管理アプリケーションです。日々の支払い情報を入力し、A4サイズのPDF精算書を簡単に生成・共有することができます。

## 📋 目次

- [機能](#-機能)
- [スクリーンショット](#-スクリーンショット)
- [技術スタック](#-技術スタック)
- [プロジェクト構造](#-プロジェクト構造)
- [セットアップ](#-セットアップ)
- [使い方](#-使い方)
- [トラブルシューティング](#-トラブルシューティング)
- [最新の変更点](#-最新の変更点-v110)
- [開発ガイド](#-開発ガイド)
- [今後の拡張予定](#-今後の拡張予定)
- [ライセンス](#-ライセンス)
- [作者](#-作者)

## ✨ 機能

### コア機能

- **精算書管理**
  - 複数の精算書を作成、保存、編集、削除
  - 精算書一覧表示（作成日順にソート）
  - 各精算書のタイトル、作成日、合計金額の表示

- **明細入力**
  - 支払日、支払い先、用途、決済手段、金額を詳細に入力
  - 明細の追加、編集、削除（スワイプ削除対応）
  - 削除前の確認ダイアログ表示 🆕
  - リアルタイムで合計金額を自動計算

- **PDF生成**
  - A4縦フォーマットの精算書PDFを生成
  - 日本語フォント（Noto Sans JP）を使用
  - プレビュー機能付き
  - 明細テーブルはWeb（Tailwind）風のデザイン（薄いヘッダー背景、罫線、角丸、A4余白など）
  - 決済手段列は「支払方法ごとにセル全体」を自動で色分け（支払方法が増えるほど色分けも自動で追加）
  - 共有・印刷機能
  - エラーハンドリング強化 🆕

- **設定管理**
  - デフォルトの申請者名設定
  - よく使う決済手段の登録・管理
  - カスタム決済手段の追加・削除

- **データ永続化**
  - Hiveを使用したローカルデータベース
  - アプリ再起動後もデータを保持
  - 高速なデータアクセス

## 📱 スクリーンショット

```
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  精算書一覧      │  │  精算書編集      │  │  PDFプレビュー   │
│                 │  │                 │  │                 │
│  📄 11月度精算書 │  │  タイトル: ____  │  │                 │
│     2024/11/15  │  │  申請者: ______  │  │   精 算 書      │
│     ¥12,500     │  │  作成日: ______  │  │                 │
│                 │  │                 │  │  申請者: 山田太郎 │
│  📄 10月度精算書 │  │  ───────────────  │  │  作成日:2024/11 │
│     2024/10/20  │  │  11/01 〇〇商店  │  │                 │
│     ¥8,300      │  │        文房具     │  │  [明細テーブル]  │
│                 │  │        ¥1,200    │  │                 │
│  [+] 新規作成    │  │                 │  │  合計: ¥12,500  │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

## 🛠 技術スタック

### フレームワーク・言語
- **Flutter**: 3.10+ (Stable channel)
- **Dart**: 3.10+

### 主要パッケージ

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `flutter_riverpod` | ^2.6.1 | 状態管理 |
| `hive` | ^2.2.3 | ローカルデータベース |
| `hive_flutter` | ^1.1.0 | Hive Flutter統合 |
| `pdf` | ^3.11.3 | PDF生成 |
| `printing` | ^5.14.2 | PDFプレビュー・共有 |
| `intl` | ^0.19.0 | 日付・数値フォーマット |
| `uuid` | ^4.5.2 | ユニークID生成 |
| `path_provider` | ^2.1.5 | ファイルパス取得 |

### 開発ツール

| パッケージ | バージョン | 用途 |
|-----------|-----------|------|
| `build_runner` | ^2.4.13 | コード生成 |
| `hive_generator` | ^2.0.1 | Hiveアダプター生成 |
| `flutter_lints` | ^5.0.0 | Lintルール |

## 📁 プロジェクト構造

```
lib/
├── main.dart                           # アプリエントリーポイント
├── core/                               # コア機能
│   ├── constants/                      # 定数管理 🆕
│   │   └── app_constants.dart          
│   └── utils/
│       └── formatting_utils.dart       # フォーマットユーティリティ
├── application/                        # アプリケーション層
│   └── providers/                      # Riverpod プロバイダー
│       ├── core_providers.dart         # コアプロバイダー（Box等）
│       ├── app_settings_provider.dart  # 設定管理
│       ├── expense_sheet_list_provider.dart  # 精算書一覧
│       └── expense_sheet_provider.dart       # 個別精算書
├── data/                               # データ層
│   ├── models/                         # データモデル
│   │   ├── expense_sheet.dart          # 精算書モデル
│   │   ├── expense_sheet.g.dart        # Hiveアダプター（自動生成）
│   │   ├── expense_item.dart           # 明細モデル
│   │   ├── expense_item.g.dart         # Hiveアダプター（自動生成）
│   │   ├── app_settings.dart           # 設定モデル
│   │   └── app_settings.g.dart         # Hiveアダプター（自動生成）
│   └── datasources/                    # データソース
│       ├── hive_expense_sheet_datasource.dart  # 精算書CRUD
│       └── hive_app_settings_datasource.dart   # 設定CRUD
├── presentation/                       # プレゼンテーション層
│   ├── screens/                        # 画面
│   │   ├── expense_sheet_list_screen.dart      # 一覧画面
│   │   ├── expense_sheet_edit_screen.dart      # 編集画面 ⚡改善
│   │   ├── expense_pdf_preview_screen.dart     # PDFプレビュー ⚡改善
│   │   └── settings_screen.dart                # 設定画面
│   └── widgets/                        # ウィジェット
│       └── expense_item_edit_bottom_sheet.dart # 明細入力UI ⚡改善
└── pdf/                                # PDF生成
    └── expense_sheet_pdf_builder.dart  # PDF生成ロジック ⚡改善
```

### アーキテクチャの特徴

- **レイヤー分離**: UI・ビジネスロジック・データアクセスを明確に分離
- **依存性の方向**: プレゼンテーション層 → アプリケーション層 → データ層
- **拡張性**: 新機能追加時に既存コードへの影響を最小限に
- **保守性**: 各層の責務が明確で、バグ修正が容易
- **定数管理**: 🆕 マジックナンバーや文字列を`AppConstants`クラスで一元管理

## 🚀 セットアップ

### 前提条件

- Flutter SDK 3.10以上がインストールされていること
- Android Studio または VS Code（Flutter拡張機能付き）
- Android SDK（Android開発の場合）
- Xcode（iOS開発の場合、macOSのみ）

### インストール手順

1. **リポジトリをクローン**

   ```bash
   git clone https://github.com/kyo09427/Invoice_Crater.git
   cd Invoice_Crater
   ```

2. **依存パッケージをインストール**

   ```bash
   flutter pub get
   ```

3. **コード生成を実行**

   Hiveのアダプターを生成します：

   ```bash
   flutter pub run build_runner build --delete-conflicting-outputs
   ```

   > **注意**: `*.g.dart` ファイルが自動生成されます。これらのファイルは編集しないでください。

4. **🔴 重要: 日本語フォントのセットアップ**

   PDF生成に日本語フォントが必要です。詳細は [SETUP_FONTS.md](SETUP_FONTS.md) を参照してください。

   **クイックセットアップ**:
   ```bash
   # フォントディレクトリを作成
   mkdir -p assets/fonts
   cd assets/fonts

   # Noto Sans JPフォントをダウンロード
   curl -o NotoSansJP-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/notosansjp/NotoSansJP%5Bwght%5D.ttf"
   cp NotoSansJP-Regular.ttf NotoSansJP-Bold.ttf

   # プロジェクトルートに戻る
   cd ../..
   ```

5. **アプリを実行**

   ```bash
   # デバッグモードで実行
   flutter run

   # リリースモードで実行
   flutter run --release
   ```

### プラットフォーム別の追加設定

#### Android

- 最小SDK: Android 9 (API Level 28)
- `android/app/build.gradle` で設定済み

#### iOS

- 最小バージョン: iOS 13.0
- `ios/Podfile` で設定済み

#### Web / Desktop

- 現在は主にAndroid/iOSを想定していますが、基本的な動作は可能です

## 📖 使い方

### 1. 新規精算書の作成

1. ホーム画面（精算書一覧）で右下の「新規作成」ボタンをタップ
2. 精算書編集画面が開きます
3. タイトルと申請者名を入力

### 1.5 精算書の削除（ホーム画面） 🆕

- **精算書をタップ**: 編集画面へ移動
- **精算書を左にスワイプ**: 削除アクション
  
  **スワイプ削除の流れ**:
  1. 🔴 精算書カードを**左にスワイプ**
  2. 赤い背景が表示（「削除」アイコン + テキスト）
  3. 指を離すと確認ダイアログが表示
  4. ⚠️ **重要な警告**: 「すべての明細データも失われます」と表示
  5. 精算書の詳細情報を確認（タイトル・作成日・明細数・合計金額）
  6. 「削除」ボタンをタップで完全削除
  
  **注意事項**:
  - ⚠️ 削除すると、その精算書のすべての明細も削除されます
  - 🔄 削除後のSnackBarから「元に戻す」可能（v1.2で実装予定）
  - 💾 現在はバックアップ機能がないため、削除前に重要なデータは確認してください

### 2. 明細の追加

1. 編集画面下部の「明細を追加」ボタンをタップ
2. ボトムシートが表示されるので、以下を入力：
   - 支払日（日付ピッカーで選択）
   - 支払い先
   - 目的・用途
   - 決済手段（ドロップダウンから選択）
   - 金額
   - 備考（任意）
3. 「保存」をタップ

### 3. 明細の編集・削除

- **編集**: 明細行をタップ
- **削除**: 明細行を**左にスワイプ** → 赤い背景が表示されたら指を離す → 確認ダイアログで「削除」を選択 🆕
  
  **スワイプ削除の特徴**:
  - 🔴 **視覚的フィードバック**: スワイプ中に赤い背景と削除アイコンが表示
  - ⚠️ **確認ダイアログ**: 誤操作防止のため削除確認が表示（削除対象の明細情報も確認可能）
  - 🔄 **スムーズなアニメーション**: Material Designに準拠した自然な動き
  - ⏪ **元に戻す**: 削除後のSnackBarから取り消し可能（v1.2で実装予定）

### 4. PDFの生成と共有

1. 編集画面右上のPDFアイコンをタップ
2. PDFプレビュー画面が表示されます
3. 共有ボタンで他のアプリに送信、または印刷

> **注意**: 🆕 PDF生成前にタイトル・申請者名・明細の有無がチェックされます

### 5. 設定のカスタマイズ

1. 一覧画面右上の歯車アイコンをタップ
2. 設定画面で以下を変更可能：
   - デフォルト申請者名
   - 決済手段の追加・削除

## 🔧 トラブルシューティング

### ビルドエラーが発生する場合

#### 1. 「*.g.dart ファイルが見つからない」エラー

```bash
flutter clean
flutter pub get
flutter pub run build_runner build --delete-conflicting-outputs
```

#### 2. PDF生成時のフォントエラー 🆕

**症状**: PDF生成時に「Font not found」エラーまたは日本語が表示されない

**原因**: Noto Sans フォントが未インストール

**解決方法**:
1. [SETUP_FONTS.md](SETUP_FONTS.md) の手順に従ってフォントをインストール
2. インターネット接続を確認
3. アプリを再起動
4. 以下のコマンドでキャッシュをクリア：

```bash
flutter clean
rm -rf ~/.pub-cache
flutter pub get
```

#### 3. Hive関連のエラー

**症状**: `HiveError: Box is already open`

**解決方法**:
```bash
# アプリをアンインストール
# または
flutter clean
```

#### 4. PDF生成エラー 🆕

**症状**: 「PDF生成中にエラーが発生しました」

**解決方法**:
- フォントファイルが正しく配置されているか確認
- 明細が1件以上あるか確認
- タイトルと申請者名が入力されているか確認
- エラーメッセージの詳細を確認

### よくある質問

**Q: データはどこに保存されますか？**

A: ローカルデバイスのアプリ専用ストレージに保存されます。アプリをアンインストールするとデータも削除されます。

**Q: データのバックアップはできますか？**

A: v1.0では未実装です。v1.1で追加予定です（ロードマップ参照）。

**Q: PDFが文字化けします**

A: 日本語フォント（Noto Sans JP）が正しくインストールされていない可能性があります。[SETUP_FONTS.md](SETUP_FONTS.md) を参照してください。

**Q: 決済手段を追加できません**

A: 設定画面で「決済手段を追加」をタップし、名前を入力してください。空白のままでは追加できません。

**Q: 精算書を削除したら明細も全部消えますか？ 🆕**

A: はい、精算書を削除すると、その精算書に含まれるすべての明細データも削除されます。
- **警告表示**: 削除確認ダイアログで「すべての明細データも失われます」と赤字で警告
- **確認情報**: 削除前に精算書の詳細（タイトル・明細数・合計金額）を確認可能
- **v1.2予定**: 「元に戻す」機能で30秒以内なら復元可能に
- **回避策**: 重要なデータは削除前にPDFとして保存しておくことを推奨

**Q: 精算書と明細、どちらも左スワイプで削除できますか？ 🆕**

A: はい、両方とも左スワイプ削除に対応しています。
- **ホーム画面**: 精算書カードを左スワイプ → 精算書全体を削除
- **編集画面**: 明細行を左スワイプ → その明細のみ削除
- **違い**: 精算書削除の方が重要度が高いため、より強い警告が表示されます

**Q: スワイプしても削除されません**

A: 以下を確認してください：
- **正しい方向**: 右から左（画面の右端から左へ）にスワイプ
- **十分な距離**: 画面の約50%以上スワイプする必要があります
- **確認ダイアログ**: 赤い背景が表示されたら指を離し、ダイアログで「削除」をタップ
- **キャンセル**: 途中で戻したい場合は、逆方向にスワイプするか確認ダイアログで「キャンセル」を選択

## 🆕 最新の変更点 (v1.1.0)

### 2024年12月 - 安定性とUX向上アップデート

#### ✅ エラーハンドリングの大幅強化

- **PDF生成**: フォント読み込み失敗時の適切なフォールバック処理
- **データ操作**: すべての非同期処理に try-catch を実装
- **ユーザーフィードバック**: エラー発生時の分かりやすいメッセージ表示
- **リトライ機能**: エラー画面からの再試行ボタン追加

#### ✅ バリデーション機能の追加

- **編集画面**: PDF生成前にタイトル・申請者名・明細数をチェック
- **明細入力**: 全必須フィールドの入力検証
- **金額チェック**: 1円〜9億9999万9999円の範囲制限
- **文字数制限**: 
  - タイトル: 100文字
  - 申請者名: 50文字
  - 支払い先: 100文字
  - 目的・用途: 200文字
  - 備考: 500文字

#### ✅ UX改善

- **スワイプ削除機能（完全実装）**:
  - **明細削除**: 編集画面で明細を左スワイプ
    - 視覚的フィードバック（赤い背景 + 削除アイコン 32px）
    - 削除確認ダイアログ（削除対象の明細情報を表示）
    - スムーズなアニメーション
  - **精算書削除** 🆕: ホーム画面で精算書カードを左スワイプ
    - より大きなアイコン（36px）で重要性を強調
    - 強い警告メッセージ（「すべての明細データも失われます」）
    - 詳細な確認情報（タイトル・作成日・明細数・合計金額）
    - カスケード削除（精算書 + 全明細）
  - 元に戻す機能のプレースホルダー（v1.2で実装予定）
- **空状態表示**: 明細/精算書がない場合の分かりやすいプレースホルダー
- **ローディング**: 各操作の進行状況を明確に表示
- **操作フィードバック**: SnackBarによる成功・失敗の通知
- **カード型UI**: より現代的で直感的なデザイン
- **改善された日付表示**: カレンダー風のビジュアルデザイン
- **決済手段アイコン**: 各明細に支払い方法のアイコン表示

#### ✅ コードの保守性向上

- **定数管理**: `AppConstants`クラスで文字列・数値を一元管理
- **カラー定義**: `AppColors`クラスでテーマカラーを統一
- **コメント追加**: 主要ロジックへの説明追加
- **エラーログ**: デバッグ情報の適切な出力

#### ✅ テストの改善

- **ウィジェットテスト**: 基本的な統合テストの修正
- **モデルテスト**: ExpenseSheet と AppSettings のユニットテスト
- **テストヘルパー**: サンプルデータ生成用のヘルパー関数

#### 📝 ドキュメントの充実

- **SETUP_FONTS.md**: フォントセットアップの詳細ガイド（新規）
- **トラブルシューティング**: よくある問題と解決方法を拡充
- **コメント**: コード内のドキュメントを大幅に追加

### 既知の制限事項

- データのバックアップ・復元機能なし（v1.2で実装予定）
- 削除の取り消し機能なし（v1.2で実装予定）
- 検索・フィルタリング機能なし（v1.3で実装予定）
- レシート画像添付機能なし（v2.0で実装予定）

## 👨‍💻 開発ガイド

### コードの規約

- **命名規則**: Dart公式ガイドラインに従う
- **ファイル名**: `snake_case` を使用
- **クラス名**: `PascalCase` を使用
- **変数名**: `camelCase` を使用
- **定数**: 🆕 `AppConstants` クラスに集約

### 新機能の追加方法

#### 例: 新しいフィールドの追加

1. **モデルの更新**

   `lib/data/models/expense_item.dart` にフィールドを追加：

   ```dart
   @HiveField(7)
   final String? receiptImagePath;
   ```

2. **コード再生成**

   ```bash
   flutter pub run build_runner build --delete-conflicting-outputs
   ```

3. **UI更新**

   `lib/presentation/widgets/expense_item_edit_bottom_sheet.dart` に入力フィールドを追加

4. **テスト**

   動作確認を実施

### デバッグのヒント

- **Riverpod DevTools**: 状態管理のデバッグに使用
- **Hive Inspector**: データベースの内容確認に使用
- **エラーログ**: 🆕 改善されたエラーメッセージを確認

```bash
# DevToolsを開く
flutter run --observatory-port=8888
```

### テストの実行

```bash
# 全テストを実行
flutter test

# 特定のテストを実行
flutter test test/widget_test.dart

# カバレッジレポート生成
flutter test --coverage
```

### 🆕 定数の追加方法

新しい定数を追加する場合は、`lib/core/constants/app_constants.dart` を編集：

```dart
class AppConstants {
  // 新しい定数を追加
  static const int maxDescriptionLength = 300;
  static const String msgNewFeature = '新機能のメッセージ';
}
```

## 🔮 今後の拡張予定

### v1.2（開発中）

- [ ] データのエクスポート/インポート機能（JSON形式）
- [ ] 削除の取り消し機能
- [ ] CSVエクスポート
- [ ] ダークモード完全対応
- [ ] 多言語対応（英語）

### v1.3（計画中）

- [ ] 検索・フィルタリング機能
- [ ] ソート機能（作成日・金額・タイトル）
- [ ] レシート画像の添付機能
- [ ] プロジェクト/カテゴリー分類
- [ ] 月次レポート生成
- [ ] グラフ表示機能（支出推移・決済手段別など）

### v2.0（構想）

- [ ] クラウド同期（Firebase）
- [ ] 複数デバイス対応
- [ ] チーム共有機能
- [ ] 承認ワークフロー
- [ ] OCR機能（レシート自動読み取り）
- [ ] 予算管理機能

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 👤 作者

**shoul (kyo09427)**

- GitHub: [@kyo09427](https://github.com/kyo09427)
- Repository: [Invoice_Crater](https://github.com/kyo09427/Invoice_Crater)

## 🙏 謝辞

このプロジェクトは以下のオープンソースライブラリを使用しています：

- [Flutter](https://flutter.dev) - Googleによるクロスプラットフォームフレームワーク
- [Riverpod](https://riverpod.dev) - Remi Rousseletによる状態管理ライブラリ
- [Hive](https://docs.hivedb.dev) - 高速なローカルデータベース
- [pdf](https://pub.dev/packages/pdf) - PDF生成ライブラリ
- [printing](https://pub.dev/packages/printing) - PDF印刷・共有ライブラリ
- [Noto Sans JP](https://fonts.google.com/noto/specimen/Noto+Sans+JP) - Google Fontsによる日本語フォント（SIL Open Font License）

---

## 📞 サポート

問題が発生した場合や機能リクエストがある場合は、[GitHubのIssues](https://github.com/kyo09427/Invoice_Crater/issues)でご報告ください。

### バグ報告時の情報

バグを報告する際は、以下の情報を含めてください：

- Flutterバージョン: `flutter --version`
- OSとバージョン
- エラーメッセージ（あれば）
- 再現手順

## 🌟 貢献

プルリクエストを歓迎します！大きな変更の場合は、まずissueを開いて変更内容を議論してください。

### 貢献の手順

1. このリポジトリをフォーク
2. フィーチャーブランチを作成 (`git checkout -b feature/amazing-feature`)
3. 変更をコミット (`git commit -m 'Add some amazing feature'`)
4. ブランチにプッシュ (`git push origin feature/amazing-feature`)
5. プルリクエストを作成

### 🆕 コントリビューター向けガイドライン

- コードスタイル: `flutter analyze` でエラーがないこと
- テスト: 新機能には適切なテストを追加
- ドキュメント: 変更内容をREADMEに反映
- 定数: 新しい文字列や数値は `AppConstants` に追加

---

<<<<<<< HEAD
## 📊 プロジェクト統計

- **総コード行数**: 約3,500行（生成コードを除く）
- **画面数**: 4画面（一覧・編集・プレビュー・設定）
- **テストカバレッジ**: 🆕 基本的なテストを実装（拡充中）
- **対応言語**: 日本語（英語対応は v1.2 予定）

---

**Built with ❤️ using Flutter**

**Last Updated**: 2024年12月 - v1.1.0リリース
=======
**Built with ❤️ using Flutter**
>>>>>>> 8dcfaee1d43ee71480e69c6d96cc0eb9c12b9ecf
